<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Ficha RPG</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
body{
  background:#0f172a;
  color:#e5e7eb;
  font-family: Arial, sans-serif;
}

.bloco{
  background:#1f2937;
  padding:18px;
  border-radius:14px;
  margin:18px auto;
  max-width:900px;
  box-shadow:0 10px 25px rgba(0,0,0,.3);
}

h2{
  margin-top:0;
  color:#a5b4fc;
  border-bottom:1px solid #374151;
  padding-bottom:6px;
}

.linha{
  margin:10px 0;
  display:flex;
  flex-direction:column;
}

input, select, textarea{
  border-radius:10px;
  border:1px solid #374151;
  padding:8px;
  background:#020617;
  color:#e5e7eb;
}

.atributo, .pericia, .habilidade{
  display:grid;
  grid-template-columns: 1fr 100px 40px 160px;
  align-items:center;
  gap:10px;
  margin:6px 0;
}

.dice{
  cursor:pointer;
  font-size:22px;
  text-align:center;
}

.resultado{
  color:#a5f3fc;
  font-size:13px;
  text-align:left;
}

.imagem-box{
  border:2px dashed #4b5563;
  border-radius:12px;
  padding:20px;
  text-align:center;
  cursor:pointer;
  margin-bottom:15px;
}

.imagem-box img{
  max-width:160px;
  border-radius:10px;
  margin-top:10px;
}

.salvar-btn{
  margin-top:15px;
  padding:10px 20px;
  border-radius:10px;
  border:none;
  background:#4f46e5;
  color:white;
  font-weight:bold;
  cursor:pointer;
}

.status-card{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:14px;
}

.status-item{
  background:#020617;
  border:1px solid #374151;
  padding:12px;
  border-radius:12px;
}

.status-top{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:6px;
}

.status-bar{
  height:8px;
  background:#1f2937;
  border-radius:10px;
  overflow:hidden;
  margin-top:6px;
}

.status-fill{
  height:8px;
  background:linear-gradient(90deg,#4ade80,#22c55e);
  width:100%;
  transition:.25s;
}

.status-fill.sanity{
  background:linear-gradient(90deg,#60a5fa,#3b82f6);
}

.status-fill.aura{
  background:linear-gradient(90deg,#fde047,#facc15);
}

.alerta{
  margin-top:10px;
  padding:8px 10px;
  border-radius:10px;
  background:#065f46;
  border:1px solid #059669;
  color:#d1fae5;
  display:none;
}
</style>
</head>

<body>

<div id="ficha">

<!-- SLOT -->
<div class="bloco">
<h2>Sele√ß√£o de Ficha</h2>
<div class="linha">
<label>Escolha o slot</label>
<select id="slot" onchange="carregarFicha()">
<option value="1">Slot 1</option>
<option value="2">Slot 2</option>
<option value="3">Slot 3</option>
<option value="4">Slot 4</option>
</select>
</div>
</div>

<!-- IMAGEM -->
<div class="bloco">
<h2>Imagem do Personagem</h2>
<div class="imagem-box" onclick="document.getElementById('imagemInput').click()">
Clique para adicionar imagem
<input type="file" id="imagemInput" accept="image/*" style="display:none">
<img id="previewImg">
</div>
</div>

<!-- B√ÅSICO -->
<div class="bloco">
<h2>Informa√ß√µes B√°sicas</h2>
<div class="linha"><label>Nome</label><input id="nome"></div>
<div class="linha"><label>Idade</label><input id="idade" type="number"></div>
<div class="linha"><label>Energia Inata</label><textarea id="antecedencia"></textarea></div>
<div class="linha"><label>Descri√ß√£o</label><textarea id="descricao"></textarea></div>
<div class="linha"><label>Hist√≥ria</label><textarea id="historia"></textarea></div>
</div>

<!-- ATRIBUTOS -->
<div class="bloco">
<h2>Atributos</h2>
<div id="atributos"></div>
</div>

<!-- PER√çCIAS -->
<div class="bloco">
<h2>Per√≠cias</h2>
<div id="pericias"></div>
</div>

<!-- STATUS -->
<div class="bloco">
<h2>Status</h2>

<div class="status-card">

<div class="status-item">
<div class="status-top"><div>Vida</div><span>‚ù§Ô∏è</span></div>
<input id="vida" type="number" value="100" oninput="atualizarBarra('vida','vida-bar',100)">
<div class="status-bar"><div id="vida-bar" class="status-fill"></div></div>
</div>

<div class="status-item">
<div class="status-top"><div>Sanidade</div><span>üß†</span></div>
<input id="sanidade" type="number" value="100" oninput="atualizarBarra('sanidade','sanidade-bar',100)">
<div class="status-bar"><div id="sanidade-bar" class="status-fill sanity"></div></div>
</div>

<div class="status-item">
<div class="status-top"><div>Aura ‚ú®</div></div>
<input id="aura" type="number" value="0" oninput="atualizarAura()">
<small id="auraMaxTxt">M√°x: 0</small>
<div class="status-bar"><div id="aura-bar" class="status-fill aura"></div></div>
</div>

</div>
</div>

<!-- HABILIDADES -->
<div class="bloco">
<h2>Habilidades</h2>

<div id="habilidades"></div>

<button class="salvar-btn" onclick="adicionarHabilidade()">+ Adicionar Habilidade</button>
</div>

<!-- SALVAR -->
<div class="bloco">
<button class="salvar-btn" onclick="salvarFicha()">Salvar ficha</button>
<div id="alerta" class="alerta">Ficha salva com sucesso!</div>
<button class="salvar-btn" onclick="gerarPDF()">Baixar PDF da ficha</button>
</div>

</div>

<script>
const atributos = [
{sigla:"FOR", nome:"For√ßa"},
{sigla:"CON", nome:"Constitui√ß√£o"},
{sigla:"AGI", nome:"Agilidade"},
{sigla:"INT", nome:"Intelecto"},
{sigla:"POD", nome:"Poder"}
];

const pericias = [
["FOR","Atletismo"],["FOR","Luta"],
["CON","Fortitude"],
["AGI","Reflexos"],["AGI","Furtividade"],["AGI","Acrobacia"],
["AGI","Iniciativa"],["AGI","Pontaria"],["AGI","Pilotagem"],
["INT","Ci√™ncias"],["INT","T√°tica"],["INT","Investiga√ß√£o"],
["INT","Medicina"],["INT","Tecnologia"],["INT","Sobreviv√™ncia"],
["INT","L√°bia"],["INT","Diplomacia"],["POD","Intimida√ß√£o"],
["INT","Artes"],["POD","Intui√ß√£o"],["INT","Percep√ß√£o"],
["INT","Adestramento"],["POD","Charme"],["POD","Vontade"]
];

let imagemBase64 = "";
let habilidades = [];

function d20(){ return Math.floor(Math.random()*20)+1; }

function limparDepois(id, ms=8000){
setTimeout(()=>{
const el = document.getElementById(id);
if(el) el.innerText="";
},ms);
}

/* ---------------- HABILIDADES ---------------- */

function adicionarHabilidade(){
habilidades.push({nome:"",desc:"",dado:""});
renderHabilidades();
}

function removerHabilidade(i){
habilidades.splice(i,1);
renderHabilidades();
}

function renderHabilidades(){
const box = document.getElementById("habilidades");
box.innerHTML="";

habilidades.forEach((h,i)=>{
box.innerHTML += `
<div class="habilidade">
<input placeholder="Nome" value="${h.nome}" 
oninput="habilidades[${i}].nome=this.value">

<input placeholder="Dado (ex: 2d6+3)" value="${h.dado}"
oninput="habilidades[${i}].dado=this.value">

<span class="dice" onclick="rolarHabilidade(${i})">üé≤</span>

<span id="resHab_${i}" class="resultado"></span>

<textarea placeholder="Descri√ß√£o"
oninput="habilidades[${i}].desc=this.value">${h.desc}</textarea>

<button onclick="removerHabilidade(${i})">‚ùå</button>
</div>
`;
});
}

function rolarHabilidade(i){
const h = habilidades[i];
const resId = "resHab_"+i;

const regex = /(\d+)d(\d+)([+-]\d+)?/i;
const match = h.dado.match(regex);

if(!match){
document.getElementById(resId).innerText = "Formato inv√°lido";
limparDepois(resId);
return;
}

const qtd = Number(match[1]);
const faces = Number(match[2]);
const mod = Number(match[3]||0);

let rolls = [];
let total = 0;

for(let r=0;r<qtd;r++){
const v = Math.floor(Math.random()*faces)+1;
rolls.push(v);
total += v;
}

total += mod;

document.getElementById(resId).innerText =
`${qtd}d${faces} [${rolls.join(" + ")}] ${mod>=0?"+":""}${mod} = ${total}`;

limparDepois(resId);
}

/* ---------------- SALVAR ---------------- */

function salvarFicha(){
const slot = slotEl().value;
const chave = "fichaRPG_"+slot;

const dados = {
nome: nome.value,
idade: idade.value,
antecedencia: antecedencia.value,
descricao: descricao.value,
historia: historia.value,
vida: vida.value,
sanidade: sanidade.value,
aura: aura.value,
imagem: imagemBase64,
habilidades: habilidades,
atributos:{},
pericias:{}
};

atributos.forEach(a=>{
dados.atributos[a.sigla] = document.getElementById("atr_"+a.sigla).value;
});

pericias.forEach((p,i)=>{
dados.pericias["per_"+i] = document.getElementById("per_"+i).value;
});

localStorage.setItem(chave,JSON.stringify(dados));

const alerta = document.getElementById("alerta");
alerta.style.display="block";
setTimeout(()=>alerta.style.display="none",2500);
}

function carregarFicha(){
const slot = slotEl().value;
const chave = "fichaRPG_"+slot;
const salvo = localStorage.getItem(chave);

if(!salvo){
habilidades=[];
renderHabilidades();
return;
}

const d = JSON.parse(salvo);

nome.value = d.nome||"";
idade.value = d.idade||"";
antecedencia.value = d.antecedencia||"";
descricao.value = d.descricao||"";
historia.value = d.historia||"";
vida.value = d.vida||100;
sanidade.value = d.sanidade||100;
aura.value = d.aura||0;

imagemBase64 = d.imagem||"";
previewImg.src = imagemBase64;

habilidades = d.habilidades||[];
renderHabilidades();
}

/* ---------------- UTIL ---------------- */
function slotEl(){ return document.getElementById("slot"); }

function atualizarBarra(inputId, barId, max=100){
const v = Math.max(0,Math.min(max,parseInt(document.getElementById(inputId).value)||0));
document.getElementById(inputId).value = v;
document.getElementById(barId).style.width = ((v/max)*100)+"%";
}

function recalcularAura(){
const con = Number(document.getElementById("atr_CON").value)||0;
const pod = Number(document.getElementById("atr_POD").value)||0;
const auraMax = (con+pod)*3;

aura.setAttribute("max",auraMax);
auraMaxTxt.innerText = "M√°x: "+auraMax;
atualizarAura();
}

function atualizarAura(){
const max = Number(aura.getAttribute("max"))||0;
let v = Number(aura.value)||0;
if(v>max) v=max;
if(v<0) v=0;
aura.value=v;
auraBar().style.width = max>0 ? ((v/max)*100)+"%" : "0%";
}

function auraBar(){ return document.getElementById("aura-bar"); }

/* ---------------- PDF ---------------- */
async function gerarPDF(){
const { jsPDF } = window.jspdf;
const ficha = document.getElementById("ficha");
const canvas = await html2canvas(ficha,{ scale:2 });
const img = canvas.toDataURL("image/png");

const pdf = new jsPDF("p","mm","a4");
const w = pdf.internal.pageSize.getWidth()-10;
const h = (canvas.height * w) / canvas.width;

pdf.addImage(img,"PNG",5,5,w,h);
pdf.save("ficha_rpg.pdf");
}

document.getElementById("imagemInput").addEventListener("change", e=>{
const file = e.target.files[0];
if(!file) return;
const reader = new FileReader();
reader.onload = ()=>{
imagemBase64 = reader.result;
previewImg.src = imagemBase64;
};
reader.readAsDataURL(file);
});

carregarFicha();
</script>

</body>
</html>
