<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Ficha RPG</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
body{
  background:#0f172a;
  color:#e5e7eb;
  font-family: Arial, sans-serif;
}

.bloco{
  background:#1f2937;
  padding:16px;
  border-radius:14px;
  margin:14px auto;
  max-width:900px;
}

.tabs{
  display:flex;
  gap:8px;
  margin-bottom:10px;
  flex-wrap:wrap;
}

.tab-btn{
  padding:8px 14px;
  border-radius:10px;
  cursor:pointer;
  background:#020617;
  border:1px solid #374151;
}

.tab-btn.active{
  background:#4f46e5;
  border-color:#6366f1;
}

.tab-content{ display:none; }
.tab-content.active{ display:block; }

input, textarea, select{
  width:100%;
  border-radius:10px;
  border:1px solid #374151;
  padding:6px;
  background:#020617;
  color:#e5e7eb;
}

.atributo, .pericia{
  display:grid;
  grid-template-columns: 1fr 90px 40px 120px;
  align-items:center;
  gap:10px;
}

.dice{ cursor:pointer;font-size:22px;text-align:center; }
.resultado{ color:#a5f3fc;font-size:12px;text-align:center; }

.salvar-btn{
  margin-top:10px;
  padding:10px 18px;
  border-radius:10px;
  border:none;
  background:#4f46e5;
  color:white;
  cursor:pointer;
}

.sucesso{
  color:#4ade80;
  font-size:12px;
  margin-top:6px;
}

/* ATAQUES */
.ataque-card{
  border:1px solid #374151;
  padding:10px;
  border-radius:12px;
  margin-top:8px;
}

.ataque-top{
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.rolagem{
  margin-top:6px;
  font-size:12px;
  color:#a5f3fc;
}
</style>
</head>

<body>

<div id="ficha" class="bloco">

<h2>Ficha do Personagem</h2>

<div class="tabs">
  <div class="tab-btn active" onclick="abrirTab('basico')">BÃ¡sico</div>
  <div class="tab-btn" onclick="abrirTab('atrib')">Atributos</div>
  <div class="tab-btn" onclick="abrirTab('pericias')">PerÃ­cias</div>
  <div class="tab-btn" onclick="abrirTab('habilidades')">Habilidades</div>
  <div class="tab-btn" onclick="abrirTab('ataques')">Ataques</div>
</div>

<!-- ====================== ABA BÃSICO ====================== -->
<div id="basico" class="tab-content active">

  <div class="imagem-box" onclick="document.getElementById('imagemInput').click()">
    Clique para adicionar imagem
    <input type="file" id="imagemInput" accept="image/*" style="display:none">
    <img id="previewImg" style="max-width:100%;border-radius:10px;margin-top:10px;">
  </div>

  <label>Nome</label>
  <input id="nome">

  <label>Idade</label>
  <input id="idade" type="number">

  <label>Energia Interna</label>
  <textarea id="antecedencia"></textarea>

  <label>DescriÃ§Ã£o</label>
  <textarea id="descricao"></textarea>

</div>

<!-- ====================== ABA ATRIBUTOS ====================== -->
<div id="atrib" class="tab-content">
  <div id="atributos"></div>
</div>

<!-- ====================== ABA PERÃCIAS ====================== -->
<div id="pericias" class="tab-content">
  <div id="periciasBox"></div>
</div>

<!-- ====================== ABA HABILIDADES ====================== -->
<div id="habilidades" class="tab-content">
  <button class="salvar-btn" onclick="addHabilidade()">Adicionar habilidade</button>
  <div id="listaHabilidades"></div>
</div>

<!-- ====================== ABA ATAQUES ====================== -->
<div id="ataques" class="tab-content">
  <button class="salvar-btn" onclick="addAtaque()">Adicionar ataque</button>
  <div id="listaAtaques"></div>
</div>

<button class="salvar-btn" onclick="salvarFicha()">Salvar ficha</button>
<div id="salvoMsg"></div>

<button class="salvar-btn" onclick="gerarPDF()">Baixar PDF</button>

</div>

<script>
function abrirTab(id){
  document.querySelectorAll(".tab-content").forEach(t=>t.classList.remove("active"));
  document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  event.target.classList.add("active");
}

const atributos=[
  {sigla:"FOR",nome:"ForÃ§a"},
  {sigla:"CON",nome:"ConstituiÃ§Ã£o"},
  {sigla:"AGI",nome:"Agilidade"},
  {sigla:"INT",nome:"Intelecto"},
  {sigla:"POD",nome:"Poder"}
];

const pericias=[
  ["FOR","Atletismo"],["FOR","Luta"],
  ["AGI","Furtividade"],["INT","InvestigaÃ§Ã£o"]
];

function criarInterface(){
  const a=document.getElementById("atributos");
  atributos.forEach(a1=>{
    a.innerHTML+=`
    <div class="atributo">
      <div>[${a1.sigla}] ${a1.nome}</div>
      <select id="atr_${a1.sigla}">
        ${[...Array(11).keys()].map(v=>`<option>${v}</option>`).join("")}
      </select>
      <span class="dice" onclick="rolarAtributo('${a1.sigla}')">ðŸŽ²</span>
      <span id="resAtr_${a1.sigla}" class="resultado"></span>
    </div>`;
  });

  const p=document.getElementById("periciasBox");
  pericias.forEach((p1,i)=>{
    const id="per_"+i;
    p.innerHTML+=`
    <div class="pericia">
      <div>[${p1[0]}] ${p1[1]}</div>
      <select id="${id}">
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
      </select>
      <span class="dice" onclick="rolarPericia('${id}','${p1[0]}')">ðŸŽ²</span>
      <span id="res_${id}" class="resultado"></span>
    </div>`;
  });
}
criarInterface();

function d20(){ return Math.floor(Math.random()*20)+1;}

function rolarAtributo(s){
  const v=Number(document.getElementById("atr_"+s).value);
  const r=d20()+v;
  const el=document.getElementById("resAtr_"+s);
  el.innerText="Resultado: "+r;
  setTimeout(()=>el.innerText="",4000);
}

function rolarPericia(id,s){
  const per=Number(document.getElementById(id).value);
  const atr=Number(document.getElementById("atr_"+s).value);
  const bonus=atr;
  const d1=d20(),d2=d20(),d3=d20();
  let texto,resultado;

  if(per===1){ resultado=d1+bonus; texto=`1d20 (${d1}) + ${bonus} = ${resultado}`;}
  else if(per===2){ const m=Math.max(d1,d2); resultado=m+bonus; texto=`2d20 (${d1}|${d2}) â†’ ${m}+${bonus}=${resultado}`;}
  else{ const m=Math.max(d1,d2,d3); resultado=m+bonus; texto=`3d20 (${d1}|${d2}|${d3}) â†’ ${m}+${bonus}=${resultado}`;}

  const el=document.getElementById("res_"+id);
  el.innerText=texto;
  setTimeout(()=>el.innerText="",4000);
}

/* ========= HABILIDADES ========= */
function addHabilidade(){
  const box=document.getElementById("listaHabilidades");
  const div=document.createElement("div");
  div.innerHTML=`<textarea class="hab" placeholder="Descreva a habilidade..."></textarea>`;
  box.appendChild(div);
}

/* ========= ATAQUES ========= */
function addAtaque(){
  const box=document.getElementById("listaAtaques");
  const div=document.createElement("div");
  div.className="ataque-card";
  div.innerHTML=`
    <div class="ataque-top">
      <input class="atkNome" placeholder="Nome do ataque">
      <span class="dice" onclick="rolarAtaque(this)">ðŸŽ²</span>
    </div>

    <label>Dano (ex: 1d6)</label>
    <input class="atkDano" placeholder="1d6">

    <div class="rolagem"></div>
  `;
  box.appendChild(div);
}

function rolarAtaque(btn){
  const card=btn.closest(".ataque-card");
  const formula=card.querySelector(".atkDano").value;

  const match=formula.match(/(\d+)d(\d+)/);
  if(!match) return;

  const n=parseInt(match[1]); 
  const faces=parseInt(match[2]);

  let soma=0;
  for(let i=0;i<n;i++){
    soma+=Math.floor(Math.random()*faces)+1;
  }

  card.querySelector(".rolagem").innerText=`Rolou ${formula} â†’ ${soma}`;
  setTimeout(()=>card.querySelector(".rolagem").innerText="",4000);
}

/* ========= IMAGEM ========= */
document.getElementById("imagemInput").addEventListener("change", e=>{
  const file=e.target.files[0];
  if(!file) return;
  const reader=new FileReader();
  reader.onload=()=>document.getElementById("previewImg").src=reader.result;
  reader.readAsDataURL(file);
});

/* ========= SALVAR LOCAL ========= */
function salvarFicha(){
  const data={
    nome: nome.value,
    idade: idade.value,
    antecedencia: antecedencia.value,
    descricao: descricao.value,
    imagem: previewImg.src || ""
  };
  localStorage.setItem("fichaRPG",JSON.stringify(data));

  const msg=document.getElementById("salvoMsg");
  msg.innerText="Ficha salva com sucesso!";
  msg.className="sucesso";
  setTimeout(()=>msg.innerText="",4000);
}

/* ========= PDF ========= */
async function gerarPDF(){
  const { jsPDF }=window.jspdf;
  const el=document.getElementById("ficha");
  const canvas=await html2canvas(el,{scale:2});
  const img=canvas.toDataURL("image/png");
  const pdf=new jsPDF("p","mm","a4");
  const w=pdf.internal.pageSize.getWidth();
  const h=(canvas.height* w)/canvas.width;
  pdf.addImage(img,"PNG",0,0,w,h);
  pdf.save("ficha.pdf");
}
</script>

</body>
</html>
