<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Ficha RPG</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
  body{
    background:#0f172a;
    color:#e5e7eb;
    font-family: Arial, sans-serif;
  }

  .bloco{
    background:#1f2937;
    padding:18px;
    border-radius:14px;
    margin:18px auto;
    max-width:900px;
    box-shadow:0 10px 25px rgba(0,0,0,.3);
  }

  h2{
    margin-top:0;
    color:#a5b4fc;
    border-bottom:1px solid #374151;
    padding-bottom:6px;
  }

  .linha{
    margin:10px 0;
    display:flex;
    flex-direction:column;
  }

  input, select, textarea{
    border-radius:10px;
    border:1px solid #374151;
    padding:8px;
    background:#020617;
    color:#e5e7eb;
  }

  .tabs{
    display:flex;
    gap:10px;
    margin-bottom:12px;
    flex-wrap:wrap;
  }

  .tab-btn{
    padding:8px 14px;
    border-radius:10px;
    border:1px solid #374151;
    background:#020617;
    color:#e5e7eb;
    cursor:pointer;
  }
  .tab-btn.active{
    background:#4f46e5;
    border-color:#6366f1;
  }

  .tab-content{ display:none; }
  .tab-content.active{ display:block; }

  .atributo, .pericia{
    display:grid;
    grid-template-columns: 1fr 90px 40px 120px;
    align-items:center;
    gap:10px;
    margin:6px 0;
  }

  .dice{ cursor:pointer;font-size:22px;text-align:center; }
  .resultado{ color:#a5f3fc;font-size:13px;text-align:center; }

  .imagem-box{
    border:2px dashed #4b5563;
    border-radius:12px;
    padding:20px;
    text-align:center;
    cursor:pointer;
    margin-bottom:15px;
  }

  .imagem-box img{
    max-width:70%;
    border-radius:10px;
    margin-top:10px;
  }

  .salvar-btn{
    margin-top:15px;
    padding:10px 20px;
    border-radius:10px;
    border:none;
    background:#4f46e5;
    color:white;
    font-weight:bold;
    cursor:pointer;
  }

  .status-card{ display:grid;grid-template-columns:1fr 1fr;gap:14px; }
  .status-item{ background:#020617;border:1px solid #374151;padding:12px;border-radius:12px; }
  .status-top{ display:flex;justify-content:space-between;align-items:center;margin-bottom:6px; }
  .status-bar{ height:8px;background:#1f2937;border-radius:10px;overflow:hidden;margin-top:6px; }
  .status-fill{ height:8px;background:linear-gradient(90deg,#4ade80,#22c55e);width:100%;transition:.25s; }
  .status-fill.sanity{ background:linear-gradient(90deg,#60a5fa,#3b82f6); }
  .status-fill.aura{ background:linear-gradient(90deg,#facc15,#eab308); }

  .alerta{
    margin-top:10px;
    padding:8px 10px;
    border-radius:10px;
    background:#065f46;
    border:1px solid #059669;
    color:#d1fae5;
    display:none;
  }
</style>
</head>

<body>

<div id="ficha">

<!-- SLOT -->
<div class="bloco">
  <h2>Sele√ß√£o de Ficha</h2>

  <div class="linha">
    <label>Escolha o slot</label>
    <select id="slot" onchange="carregarFicha()">
      <option value="1">Slot 1</option>
      <option value="2">Slot 2</option>
      <option value="3">Slot 3</option>
      <option value="4">Slot 4</option>
    </select>
  </div>
</div>

<!-- IMAGEM -->
<div class="bloco">
  <h2>Imagem do Personagem</h2>
  <div class="imagem-box" onclick="document.getElementById('imagemInput').click()">
    Clique para adicionar imagem
    <input type="file" id="imagemInput" accept="image/*" style="display:none">
    <img id="previewImg">
  </div>
</div>

<!-- TABS -->
<div class="bloco">
  <div class="tabs">
    <button class="tab-btn active" onclick="abrirTab('info')">INFO</button>
    <button class="tab-btn" onclick="abrirTab('atributosTab')">ATRIBUTOS</button>
    <button class="tab-btn" onclick="abrirTab('periciasTab')">PER√çCIAS</button>
    <button class="tab-btn" onclick="abrirTab('statusTab')">STATUS</button>
  </div>

  <!-- INFO -->
  <div id="info" class="tab-content active">
    <h2>Informa√ß√µes B√°sicas</h2>
    <div class="linha"><label>Nome</label><input id="nome"></div>
    <div class="linha"><label>Idade</label><input id="idade" type="number"></div>
    <div class="linha"><label>Energia Interna</label><textarea id="antecedencia"></textarea></div>
    <div class="linha"><label>Descri√ß√£o</label><textarea id="descricao"></textarea></div>
    <div class="linha"><label>Hist√≥ria</label><textarea id="historia"></textarea></div>
  </div>

  <!-- ATRIBUTOS -->
  <div id="atributosTab" class="tab-content">
    <h2>Atributos</h2>
    <div id="atributos"></div>
  </div>

  <!-- PER√çCIAS -->
  <div id="periciasTab" class="tab-content">
    <h2>Per√≠cias</h2>
    <div id="pericias"></div>
  </div>

  <!-- STATUS -->
  <div id="statusTab" class="tab-content">
    <h2>Status</h2>

    <div class="status-card">

      <div class="status-item">
        <div class="status-top"><div>Vida</div><span>‚ù§Ô∏è</span></div>
        <input id="vida" type="number" value="100" oninput="atualizarBarra('vida','vida-bar')">
        <div class="status-bar"><div id="vida-bar" class="status-fill"></div></div>
      </div>

      <div class="status-item">
        <div class="status-top"><div>Sanidade</div><span>üß†</span></div>
        <input id="sanidade" type="number" value="100" oninput="atualizarBarra('sanidade','sanidade-bar')">
        <div class="status-bar"><div id="sanidade-bar" class="status-fill sanity"></div></div>
      </div>

      <!-- AURA -->
      <div class="status-item" style="grid-column:1 / span 2">
        <div class="status-top"><div>Aura</div><span‚ú®></span></div>
        <div id="auraValor">0</div>
        <div class="status-bar">
          <div id="aura-bar" class="status-fill aura"></div>
        </div>
      </div>

    </div>
  </div>

</div>

<!-- CONTROLES -->
<div class="bloco">
  <button class="salvar-btn" onclick="salvarFicha()">Salvar ficha</button>
  <div id="alerta" class="alerta">Ficha salva com sucesso!</div>

  <button class="salvar-btn" onclick="gerarPDF()">Baixar PDF da ficha</button>
</div>

</div>

<script>
/* ====================== DADOS BASE ====================== */

const atributos = [
  {sigla:"FOR", nome:"For√ßa"},
  {sigla:"CON", nome:"Constitui√ß√£o"},
  {sigla:"AGI", nome:"Agilidade"},
  {sigla:"INT", nome:"Intelecto"},
  {sigla:"POD", nome:"Poder"}
];

const pericias = [
  ["FOR","Atletismo"],["FOR","Luta"],
  ["CON","Fortitude"],
  ["AGI","Reflexos"],["AGI","Furtividade"],["AGI","Acrobacia"],
  ["AGI","Iniciativa"],["AGI","Pontaria"],["AGI","Pilotagem"],
  ["INT","Ci√™ncias"],["INT","T√°tica"],["INT","Investiga√ß√£o"],
  ["INT","Medicina"],["INT","Tecnologia"],["INT","Sobreviv√™ncia"],
  ["INT","L√°bia"],["INT","Diplomacia"],
  ["POD","Intimida√ß√£o"],["INT","Artes"],
  ["POD","Intui√ß√£o"],["INT","Percep√ß√£o"],
  ["INT","Adestramento"],["POD","Charme"],
  ["POD","Vontade"],

  /* NOVA PER√çCIA */
  ["POD","Energia"]
];

/* ====================== TABS ====================== */

function abrirTab(id){
  document.querySelectorAll(".tab-content").forEach(t=>t.classList.remove("active"));
  document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));

  document.getElementById(id).classList.add("active");
  event.target.classList.add("active");
}

/* ====================== INTERFACE ====================== */

function criarInterface(){
  const aBox = document.getElementById("atributos");
  aBox.innerHTML = "";
  atributos.forEach(a=>{
    aBox.innerHTML += `
      <div class="atributo">
        <div>[${a.sigla}] ${a.nome}</div>
        <select id="atr_${a.sigla}" onchange="atualizarAura()">
          ${[...Array(11).keys()].map(v=>`<option>${v}</option>`).join("")}
        </select>
        <span class="dice" onclick="rolarAtributo('${a.sigla}')">üé≤</span>
        <span id="resAtr_${a.sigla}" class="resultado"></span>
      </div>`;
  });

  const pBox = document.getElementById("pericias");
  pBox.innerHTML = "";
  pericias.forEach((p,i)=>{
    const id = "per_"+i;
    pBox.innerHTML += `
      <div class="pericia">
        <div>[${p[0]}] ${p[1]}</div>
        <select id="${id}">
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
        </select>
        <span class="dice" onclick="rolarPericia('${id}','${p[0]}')">üé≤</span>
        <span id="res_${id}" class="resultado"></span>
      </div>`;
  });
}
criarInterface();

/* ====================== DADOS & RESULTADOS ====================== */

function d20(){ return Math.floor(Math.random()*20)+1; }

function limparDepois(id, ms=8000){
  setTimeout(()=>{
    const el = document.getElementById(id);
    if(el) el.innerText = "";
  }, ms);
}

function rolarAtributo(sigla){
  const v = Number(document.getElementById("atr_"+sigla).value);
  const resId = "resAtr_"+sigla;
  document.getElementById(resId).innerText = "Resultado: " + (d20()+v);
  limparDepois(resId);
}

function rolarPericia(id, sigla){
  const per = Number(document.getElementById(id).value);
  const atr = Number(document.getElementById("atr_" + sigla).value);
  const bonus = atr;

  const d1 = d20();
  const d2 = d20();
  const d3 = d20();

  let resultado, texto;

  if (per === 1){
    resultado = d1 + bonus;
    texto = `1d20 (${d1}) + ${bonus} = ${resultado}`;
  } else if (per === 2){
    const maior = Math.max(d1, d2);
    resultado = maior + bonus;
    texto = `2d20 (${d1} | ${d2}) ‚Üí ${maior} + ${bonus} = ${resultado}`;
  } else {
    const maior = Math.max(d1, d2, d3);
    resultado = maior + bonus;
    texto = `3d20 (${d1} | ${d2} | ${d3}) ‚Üí ${maior} + ${bonus} = ${resultado}`;
  }

  const resId = "res_" + id;
  document.getElementById(resId).innerText = texto;
  limparDepois(resId);
}

/* ====================== IMAGEM ====================== */

let imagemBase64 = "";

document.getElementById("imagemInput").addEventListener("change", e=>{
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = ()=>{
    imagemBase64 = reader.result;
    document.getElementById("previewImg").src = imagemBase64;
  };
  reader.readAsDataURL(file);
});

/* ====================== STATUS BARRAS ====================== */

function atualizarBarra(inputId, barId){
  const v = Math.min(100, Math.max(1, parseInt(document.getElementById(inputId).value)||1));
  document.getElementById(barId).style.width = v+"%";
}
atualizarBarra("vida","vida-bar");
atualizarBarra("sanidade","sanidade-bar");

/* --------- AURA --------- */

function atualizarAura(){
  const con = Number(document.getElementById("atr_CON").value || 0);
  const pod = Number(document.getElementById("atr_POD").value || 0);

  const aura = (con + pod) * 3;

  document.getElementById("auraValor").innerText = aura;

  const percent = Math.min(100, aura);
  document.getElementById("aura-bar").style.width = percent + "%";
}

/* ====================== SALVAR ====================== */

function salvarFicha(){
  const slot = document.getElementById("slot").value;
  const chave = "fichaRPG_" + slot;

  const dados = {
    nome: nome.value,
    idade: idade.value,
    antecedencia: antecedencia.value,
    descricao: descricao.value,
    historia: historia.value,
    vida: vida.value,
    sanidade: sanidade.value,
    imagem: imagemBase64,
    atributos: {},
    pericias: {}
  };

  atributos.forEach(a=>{
    dados.atributos[a.sigla] = document.getElementById("atr_"+a.sigla).value;
  });

  pericias.forEach((p,i)=>{
    dados.pericias["per_"+i] = document.getElementById("per_"+i).value;
  });

  localStorage.setItem(chave, JSON.stringify(dados));

  const alerta = document.getElementById("alerta");
  alerta.style.display = "block";
  setTimeout(()=> alerta.style.display="none", 2500);
}

/* ====================== CARREGAR ====================== */

function carregarFicha(){
  const slot = document.getElementById("slot").value;
  const chave = "fichaRPG_" + slot;

  const salvo = localStorage.getItem(chave);
  if(!salvo){
    limparCampos();
    return;
  }

  const d = JSON.parse(salvo);

  nome.value = d.nome || "";
  idade.value = d.idade || "";
  antecedencia.value = d.antecedencia || "";
  descricao.value = d.descricao || "";
  historia.value = d.historia || "";
  vida.value = d.vida || 100;
  sanidade.value = d.sanidade || 100;

  imagemBase64 = d.imagem || "";
  document.getElementById("previewImg").src = imagemBase64 || "";

  atualizarBarra("vida","vida-bar");
  atualizarBarra("sanidade","sanidade-bar");

  for(const s in d.atributos){
    const el = document.getElementById("atr_"+s);
    if(el) el.value = d.atributos[s];
  }

  for(const p in d.pericias){
    const el = document.getElementById(p);
    if(el) el.value = d.pericias[p];
  }

  atualizarAura();
}

function limparCampos(){
  nome.value = "";
  idade.value = "";
  antecedencia.value = "";
  descricao.value = "";
  historia.value = "";
  vida.value = 100;
  sanidade.value = 100;
  imagemBase64 = "";
  document.getElementById("previewImg").src = "";
}

/* carregar slot inicial */
carregarFicha();

/* ====================== PDF ====================== */

async function gerarPDF(){
  const { jsPDF } = window.jspdf;
  const ficha = document.getElementById("ficha");
  const canvas = await html2canvas(ficha,{ scale:2 });
  const img = canvas.toDataURL("image/png");

  const pdf = new jsPDF("p","mm","a4");
  const pageW = pdf.internal.pageSize.getWidth();
  const pageH = pdf.internal.pageSize.getHeight();

  const imgProps = pdf.getImageProperties(img);
  const ratio = imgProps.width / imgProps.height;

  let w = pageW - 10;
  let h = w / ratio;

  if(h > pageH){
    h = pageH - 10;
    w = h * ratio;
  }

  pdf.addImage(img,"PNG",5,5,w,h);
  pdf.save("ficha_rpg.pdf");
}
</script>

</body>
</html>
