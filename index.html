<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Ficha RPG</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
body{
  background:#0f172a;
  color:#e5e7eb;
  font-family: Arial, sans-serif;
}

.bloco{
  background:#1f2937;
  padding:18px;
  border-radius:14px;
  margin:18px auto;
  max-width:900px;
  box-shadow:0 10px 25px rgba(0,0,0,.3);
}

h2{
  margin-top:0;
  color:#a5b4fc;
  border-bottom:1px solid #374151;
  padding-bottom:6px;
}

.linha{
  margin:10px 0;
  display:flex;
  flex-direction:column;
}

input, select, textarea{
  border-radius:10px;
  border:1px solid #374151;
  padding:8px;
  background:#020617;
  color:#e5e7eb;
}

.atributo, .pericia, .habilidade{
  display:grid;
  grid-template-columns: 1fr 90px 40px 160px;
  align-items:center;
  gap:10px;
  margin:6px 0;
}

.dice{
  cursor:pointer;
  font-size:22px;
  text-align:center;
}

.resultado{
  color:#a5f3fc;
  font-size:13px;
}

.status-card{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:14px;
}

.status-item{
  background:#020617;
  border:1px solid #374151;
  padding:12px;
  border-radius:12px;
}

.status-top{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:6px;
}

.status-bar{
  height:8px;
  background:#1f2937;
  border-radius:10px;
  overflow:hidden;
  margin-top:6px;
  cursor:pointer;
}

.status-fill{
  height:8px;
  background:linear-gradient(90deg,#4ade80,#22c55e);
  width:100%;
  transition:.25s;
}

.status-fill.sanity{
  background:linear-gradient(90deg,#60a5fa,#3b82f6);
}

.status-fill.aura{
  background:linear-gradient(90deg,#fde047,#facc15);
}

.alerta{
  margin-top:10px;
  padding:8px 10px;
  border-radius:10px;
  background:#065f46;
  border:1px solid #059669;
  color:#d1fae5;
  display:none;
}

.salvar-btn{
  margin-top:10px;
  padding:10px 20px;
  border-radius:10px;
  border:none;
  background:#4f46e5;
  color:white;
  font-weight:bold;
  cursor:pointer;
}
</style>
</head>

<body>

<div id="ficha">

<!-- SLOT -->
<div class="bloco">
<h2>Sele√ß√£o de Ficha</h2>
<div class="linha">
<label>Escolha o slot</label>
<select id="slot" onchange="carregarFicha()">
<option value="1">Slot 1</option>
<option value="2">Slot 2</option>
<option value="3">Slot 3</option>
<option value="4">Slot 4</option>
</select>
</div>
</div>

<!-- B√ÅSICO -->
<div class="bloco">
<h2>Informa√ß√µes B√°sicas</h2>
<div class="linha">
  <label>Imagem do Personagem</label>
  <input type="file" id="imgUpload" accept="image/*" onchange="carregarImagem(event)">
</div>

<div class="linha" style="text-align:center;">
  <img id="previewImg" 
       style="max-width:200px; max-height:200px; border-radius:12px; border:1px solid #374151; display:none;">
</div>
<div class="linha"><label>Nome</label><input id="nome"></div>
<div class="linha"><label>Idade</label><input id="idade" type="number"></div>
<div class="linha"><label>Energia Inata</label><textarea id="antecedencia"></textarea></div>
<div class="linha"><label>Descri√ß√£o</label><textarea id="descricao"></textarea></div>
<div class="linha"><label>Hist√≥ria</label><textarea id="historia"></textarea></div>
</div>

<!-- ATRIBUTOS -->
<div class="bloco">
<h2>Atributos</h2>

<div class="linha">
<label>N√≠vel do Personagem (1 a 4)</label>
<select id="nivel" onchange="recalcularVidaSanidade()">
<option value="1">1</option>
<option value="2">2</option>
<option value="3">3</option>
<option value="4">4</option>
</select>
</div>

<div id="atributos"></div>
</div>

<!-- PER√çCIAS -->
<div class="bloco">
<h2>Per√≠cias</h2>
<div id="pericias"></div>
</div>

<!-- STATUS -->
<div class="bloco">
<h2>Status</h2>
<div class="status-card">

<div class="status-item">
<div class="status-top"><div>Vida</div><span>‚ù§Ô∏è</span></div>
<input id="vida" type="number" readonly>
<small id="vidaMaxTxt"></small>
<div class="status-bar">
  <div id="vida-bar" class="status-fill"></div>
</div>
</div>

<div class="status-item">
<div class="status-top"><div>Sanidade</div><span>üß†</span></div>
<input id="sanidade" type="number" readonly>
<small id="sanidadeMaxTxt"></small>
<div class="status-bar">
  <div id="sanidade-bar" class="status-fill sanity"></div>
</div>
</div>

<div class="status-item">
<div class="status-top"><div>Aura ‚ú®</div></div>
<input id="aura" type="number" value="0" oninput="atualizarAura()">
<small id="auraMaxTxt">M√°x: 0</small>
<div class="status-bar">
  <div id="aura-bar" class="status-fill aura"></div>
</div>
</div>

</div>
</div>

<!-- HABILIDADES -->
<div class="bloco">
<h2>Habilidades</h2>
<div id="habilidades"></div>
<button class="salvar-btn" onclick="adicionarHabilidade()">+ Adicionar Habilidade</button>
</div>

<!-- SALVAR / PDF -->
<div class="bloco">
<button class="salvar-btn" onclick="salvarFicha()">Salvar ficha</button>
<div id="alerta" class="alerta">Ficha salva com sucesso!</div>
<button class="salvar-btn" onclick="gerarPDF()">Baixar PDF da ficha</button>
</div>

</div>

<script>
/* ================= DADOS ================= */
const atributos = [
{sigla:"FOR", nome:"For√ßa"},
{sigla:"CON", nome:"Constitui√ß√£o"},
{sigla:"AGI", nome:"Agilidade"},
{sigla:"INT", nome:"Intelecto"},
{sigla:"POD", nome:"Poder"}
];

const pericias = [
["FOR","Atletismo"],["FOR","Luta"],
["CON","Fortitude"],
["AGI","Reflexos"],["AGI","Furtividade"],["AGI","Acrobacia"],
["AGI","Iniciativa"],["AGI","Pontaria"],["AGI","Pilotagem"],
["INT","Ci√™ncias"],["INT","T√°tica"],["INT","Investiga√ß√£o"],
["INT","Medicina"],["INT","Tecnologia"],["INT","Sobreviv√™ncia"],
["INT","L√°bia"],["INT","Diplomacia"],["POD","Intimida√ß√£o"],
["INT","Artes"],["POD","Intui√ß√£o"],["INT","Percep√ß√£o"],
["INT","Adestramento"],["POD","Charme"],["POD","Vontade"],["POD","Energia"]
];

let habilidades = [];

/* ================= INTERFACE ================= */
function criarInterface(){
  const aBox = document.getElementById("atributos");
  aBox.innerHTML = "";

  atributos.forEach(a=>{
    aBox.innerHTML += `
    <div class="atributo">
      <div>[${a.sigla}] ${a.nome}</div>
      <select id="atr_${a.sigla}" onchange="recalcularVidaSanidade()">
        ${[...Array(11).keys()].map(v=>`<option value="${v}">${v}</option>`).join("")}
      </select>
      <span class="dice" onclick="rolarAtributo('${a.sigla}')">üé≤</span>
      <span id="resAtr_${a.sigla}" class="resultado"></span>
    </div>`;
  });

  const pBox = document.getElementById("pericias");
  pBox.innerHTML = "";

  pericias.forEach((p,i)=>{
    const id = "per_"+i;
    pBox.innerHTML += `
    <div class="pericia">
      <div>[${p[0]}] ${p[1]}</div>
      <select id="${id}">
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
      </select>
      <span class="dice" onclick="rolarPericia('${id}','${p[0]}')">üé≤</span>
      <span id="res_${id}" class="resultado"></span>
    </div>`;
  });
}

/* ================= ROLAGENS ================= */
function d20(){ return Math.floor(Math.random()*20)+1; }

function limparDepois(id,ms=8000){
  setTimeout(()=>{
    const el=document.getElementById(id);
    if(el) el.innerText="";
  },ms);
}

function rolarAtributo(sigla){
  const v=Number(document.getElementById("atr_"+sigla).value);
  const resId="resAtr_"+sigla;
  const d=d20();
  document.getElementById(resId).innerText=`1d20 (${d}) + ${v} = ${d+v}`;
  limparDepois(resId);
}

function rolarPericia(id,sigla){
  const per=Number(document.getElementById(id).value);
  const atr=Number(document.getElementById("atr_"+sigla).value);
  const bonus=atr;

  const d1=d20(), d2=d20(), d3=d20();
  let texto;

  if(per===1){
    texto=`1d20 (${d1}) + ${bonus} = ${d1+bonus}`;
  }else if(per===2){
    const maior=Math.max(d1,d2);
    texto=`2d20 (${d1} | ${d2}) ‚Üí ${maior} + ${bonus} = ${maior+bonus}`;
  }else{
    const maior=Math.max(d1,d2,d3);
    texto=`3d20 (${d1} | ${d2} | ${d3}) ‚Üí ${maior} + ${bonus} = ${maior+bonus}`;
  }

  const resId="res_"+id;
  document.getElementById(resId).innerText=texto;
  limparDepois(resId);
}

/* ================= VIDA, SANIDADE & AURA ================= */
function recalcularVidaSanidade(){
  const nivel = Number(document.getElementById("nivel").value) || 1;
  const con = Number(document.getElementById("atr_CON").value) || 0;
  const pod = Number(document.getElementById("atr_POD").value) || 0;

  const vidaMax = (20 + con * 2) * nivel;
  const sanidadeMax = 25 * nivel;
  const auraMax = (con + pod) * 3;

  vida.value = vidaMax;
  sanidade.value = sanidadeMax;

  vidaMaxTxt.innerText = "M√°x: " + vidaMax;
  sanidadeMaxTxt.innerText = "M√°x: " + sanidadeMax;

  aura.setAttribute("max", auraMax);
  auraMaxTxt.innerText = "M√°x: " + auraMax;

  atualizarBarra("vida","vida-bar",vidaMax);
  atualizarBarra("sanidade","sanidade-bar",sanidadeMax);
  atualizarAura();
}

function atualizarBarra(inputId,barId,max){
  const v = Number(document.getElementById(inputId).value) || 0;
  document.getElementById(barId).style.width =
    max > 0 ? ((v / max) * 100) + "%" : "0%";
}

function atualizarAura(){
  const max=Number(aura.getAttribute("max"))||0;
  let v=Number(aura.value)||0;
  if(v>max) v=max;
  if(v<0) v=0;
  aura.value=v;
  document.getElementById("aura-bar").style.width=
    max>0?((v/max)*100)+"%":"0%";
}

/* ================= HABILIDADES ================= */
function adicionarHabilidade(){
  habilidades.push({nome:"",desc:"",dado:""});
  renderHabilidades();
}

function removerHabilidade(i){
  habilidades.splice(i,1);
  renderHabilidades();
}

function renderHabilidades(){
  const box=document.getElementById("habilidades");
  box.innerHTML="";

  habilidades.forEach((h,i)=>{
    box.innerHTML+=`
    <div class="habilidade">
      <input placeholder="Nome" value="${h.nome}" 
        oninput="habilidades[${i}].nome=this.value">
      <input placeholder="Dado (ex: 2d6+3)" value="${h.dado}"
        oninput="habilidades[${i}].dado=this.value">
      <span class="dice" onclick="rolarHabilidade(${i})">üé≤</span>
      <span id="resHab_${i}" class="resultado"></span>
      <textarea placeholder="Descri√ß√£o"
        oninput="habilidades[${i}].desc=this.value">${h.desc}</textarea>
      <button onclick="removerHabilidade(${i})">‚ùå</button>
    </div>`;
  });
}

function rolarHabilidade(i){
  const h=habilidades[i];
  const resId="resHab_"+i;

  const regex=/(\d+)d(\d+)([+-]\d+)?/i;
  const match=h.dado.match(regex);

  if(!match){
    document.getElementById(resId).innerText="Formato inv√°lido";
    limparDepois(resId);
    return;
  }

  const qtd=Number(match[1]);
  const faces=Number(match[2]);
  const mod=Number(match[3]||0);

  let rolls=[], total=0;
  for(let r=0;r<qtd;r++){
    const v=Math.floor(Math.random()*faces)+1;
    rolls.push(v);
    total+=v;
  }
  total+=mod;

  document.getElementById(resId).innerText=
    `${qtd}d${faces} [${rolls.join(" + ")}] ${mod>=0?"+":""}${mod} = ${total}`;

  limparDepois(resId);
}

/* ================= SALVAR ================= */

function carregarImagem(event){
  const file = event.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = function(e){
    const img = document.getElementById("previewImg");
    img.src = e.target.result;
    img.style.display = "block";

    // salva imagem temporariamente para o slot
    img.dataset.base64 = e.target.result;
  };
  reader.readAsDataURL(file);
}
  
function salvarFicha(){
  const slot=document.getElementById("slot").value;
  const chave="fichaRPG_"+slot;

  const dados={
    imagem: document.getElementById("previewImg").dataset.base64 || "",
    nome:nome.value,
    idade:idade.value,
    antecedencia:antecedencia.value,
    descricao:descricao.value,
    historia:historia.value,
    nivel:nivel.value,
    vida:vida.value,
    sanidade:sanidade.value,
    aura:aura.value,
    habilidades:habilidades,
    atributos:{},
    pericias:{}
  };

  atributos.forEach(a=>{
    dados.atributos[a.sigla]=document.getElementById("atr_"+a.sigla).value;
  });

  pericias.forEach((p,i)=>{
    dados.pericias["per_"+i]=document.getElementById("per_"+i).value;
  });

  localStorage.setItem(chave,JSON.stringify(dados));

  const alerta=document.getElementById("alerta");
  alerta.style.display="block";
  setTimeout(()=>alerta.style.display="none",2500);
}

/* ================= CARREGAR ================= */
function carregarFicha(){
  const slot=document.getElementById("slot").value;
  const chave="fichaRPG_"+slot;
  const salvo=localStorage.getItem(chave);

  if(!salvo){
    recalcularVidaSanidade();
    return;
  }

  const d=JSON.parse(salvo);

  nome.value=d.nome||"";
  idade.value=d.idade||"";
  antecedencia.value=d.antecedencia||"";
  descricao.value=d.descricao||"";
  historia.value=d.historia||"";
  nivel.value=d.nivel||1;
  aura.value=d.aura||0;
  const img = document.getElementById("previewImg");
if(d.imagem){
  img.src = d.imagem;
  img.style.display = "block";
  img.dataset.base64 = d.imagem;
}else{
  img.style.display = "none";
  img.dataset.base64 = "";
}

  for(const s in d.atributos){
    const el=document.getElementById("atr_"+s);
    if(el) el.value=d.atributos[s];
  }

  for(const p in d.pericias){
    const el=document.getElementById(p);
    if(el) el.value=d.pericias[p];
  }

  habilidades=d.habilidades||[];
  renderHabilidades();

  recalcularVidaSanidade();
}

/* ================= PDF ================= */
async function gerarPDF(){
  const { jsPDF }=window.jspdf;
  const ficha=document.getElementById("ficha");
  const canvas=await html2canvas(ficha,{scale:2});
  const img=canvas.toDataURL("image/png");

  const pdf=new jsPDF("p","mm","a4");
  const w=pdf.internal.pageSize.getWidth()-10;
  const h=(canvas.height*w)/canvas.width;

  pdf.addImage(img,"PNG",5,5,w,h);
  pdf.save("ficha_rpg.pdf");
}

/* ================= START ================= */
criarInterface();
carregarFicha();
</script>

</body>
</html>
